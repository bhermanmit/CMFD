<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMFD: /home/bherman/Documents/PhD/CMFD/src/cmfd_jacobian_operator.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CMFD</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>      </li>
      <li class="navelem"><a class="el" href="dir_afcdd5e0edc0b371418ed6fb21b6270d.html">bherman</a>      </li>
      <li class="navelem"><a class="el" href="dir_3201ddb1ceaf11262981f79926d55b34.html">Documents</a>      </li>
      <li class="navelem"><a class="el" href="dir_8618e8944a8ba0368b5596bf6a0bf90b.html">PhD</a>      </li>
      <li class="navelem"><a class="el" href="dir_0e285d84ac0545df775f743b98d4c43a.html">CMFD</a>      </li>
      <li class="navelem"><a class="el" href="dir_6146a08e605ebd85439d35f097622cfc.html">src</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>cmfd_jacobian_operator.F90</h1>  </div>
</div>
<div class="contents">
<a href="cmfd__jacobian__operator_8F90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacecmfd__jacobian__operator.html">00001</a> <span class="keyword">module</span> cmfd_jacobian_operator
<a name="l00002"></a>00002 
<a name="l00003"></a>00003   use <span class="keywordflow">cmfd_loss_operator</span>,     only: loss_operator,init_M_operator,             &amp;
<a name="l00004"></a>00004  &amp;                                  build_loss_matrix,destroy_M_operator
<a name="l00005"></a>00005   use <span class="keywordflow">cmfd_prod_operator</span>,     only: prod_operator,init_F_operator,             &amp;
<a name="l00006"></a>00006  &amp;                                  build_prod_matrix,destroy_F_operator
<a name="l00007"></a>00007 
<a name="l00008"></a>00008   <span class="keyword">implicit none</span>
<a name="l00009"></a>00009   <span class="keywordtype">private</span>
<a name="l00010"></a>00010   <span class="keywordtype">public</span> :: <a class="code" href="namespacecmfd__jacobian__operator.html#add222b5e5f1a90c034998351a9b4f807">init_J_operator</a>,<a class="code" href="namespacecmfd__jacobian__operator.html#ac2d1b67173c3e7f9e41479ae5b95e3eb">build_jacobian_matrix</a>,<a class="code" href="namespacecmfd__jacobian__operator.html#a95ee83b3c9b9cd5e547ffc86001b8016">destroy_J_operator</a>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;finclude/petsc.h90&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="namespacecmfd__jacobian__operator.html#aade100f099e0a5a94c9247ff7310b676">00014</a>   <span class="keywordtype">integer</span>  :: nx   <span class="comment">! maximum number of x cells</span>
<a name="l00015"></a><a class="code" href="namespacecmfd__jacobian__operator.html#a4eff5cd260d73a37745eadedcb582b00">00015</a>   <span class="keywordtype">integer</span>  :: ny   <span class="comment">! maximum number of y cells</span>
<a name="l00016"></a><a class="code" href="namespacecmfd__jacobian__operator.html#a194567d4fd0cd9093ff3096be8d38418">00016</a>   <span class="keywordtype">integer</span>  :: nz   <span class="comment">! maximum number of z cells</span>
<a name="l00017"></a><a class="code" href="namespacecmfd__jacobian__operator.html#a417852f6bd56b5d466aa9bee0064b057">00017</a>   <span class="keywordtype">integer</span>  :: ng   <span class="comment">! maximum number of groups</span>
<a name="l00018"></a><a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">00018</a>   <span class="keywordtype">integer</span>  :: ierr <span class="comment">! petsc error code</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020   <span class="keyword">type</span>, public :: jacobian_operator
<a name="l00021"></a>00021 
<a name="l00022"></a>00022     Mat      :: J    <span class="comment">! petsc matrix for neutronic prod operator</span>
<a name="l00023"></a>00023     <span class="keywordtype">integer</span>  :: n    <span class="comment">! dimensions of matrix</span>
<a name="l00024"></a>00024     <span class="keywordtype">integer</span>  :: nnz  <span class="comment">! max number of nonzeros</span>
<a name="l00025"></a>00025     <span class="keywordtype">integer</span>  :: localn <span class="comment">! local size on proc</span>
<a name="l00026"></a>00026     <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: d_nnz(:) <span class="comment">! vector of diagonal preallocation</span>
<a name="l00027"></a>00027     <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: o_nnz(:) <span class="comment">! vector of off-diagonal preallocation</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="keyword">  end type jacobian_operator</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031   <span class="keyword">type</span>, public :: operators 
<a name="l00032"></a>00032     <span class="keywordtype">type(loss_operator)</span>   :: loss
<a name="l00033"></a>00033     <span class="keywordtype">type(prod_operator)</span>   :: prod
<a name="l00034"></a>00034 <span class="keyword">  end type operators</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">contains</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">!==============================================================================</span>
<a name="l00039"></a>00039 <span class="comment">! INIT_J_OPERATOR</span>
<a name="l00040"></a>00040 <span class="comment">!==============================================================================</span>
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="namespacecmfd__jacobian__operator.html#add222b5e5f1a90c034998351a9b4f807">00042</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__jacobian__operator.html#add222b5e5f1a90c034998351a9b4f807">init_J_operator</a>(this,ctx)
<a name="l00043"></a>00043 
<a name="l00044"></a>00044     <span class="keywordtype">type(jacobian_operator)</span> :: this
<a name="l00045"></a>00045     <span class="keywordtype">type(operators)</span>         :: ctx
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="comment">! get indices</span>
<a name="l00048"></a>00048     call get_J_indices(this)
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="comment">! get preallocation</span>
<a name="l00051"></a>00051     call <a class="code" href="namespacecmfd__jacobian__operator.html#a9abb734d2b1afc97812890b5d95aec70">preallocate_jacobian_matrix</a>(this,ctx)
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">! set up M operator</span>
<a name="l00054"></a>00054     call MatCreateMPIAIJ(PETSC_COMM_WORLD,this%localn,this%localn,PETSC_DECIDE,&amp;
<a name="l00055"></a>00055    &amp; PETSC_DECIDE,PETSC_NULL_INTEGER,this%d_nnz,PETSC_NULL_INTEGER,this%o_nnz, &amp;
<a name="l00056"></a>00056    &amp; this%J,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00057"></a>00057     call MatSetOption(this%J,MAT_NEW_NONZERO_LOCATIONS,PETSC_TRUE,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00058"></a>00058     call MatSetOption(this%J,MAT_IGNORE_ZERO_ENTRIES,PETSC_TRUE,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keyword">  end subroutine init_J_operator</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">!==============================================================================</span>
<a name="l00063"></a>00063 <span class="comment">! GET_J_INDICES</span>
<a name="l00064"></a>00064 <span class="comment">!==============================================================================</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   <span class="keyword">subroutine </span>get_J_indices(this)
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="keywordtype">type(jacobian_operator)</span> :: this
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="comment">! get maximum number of cells in each direction</span>
<a name="l00073"></a>00073     <a class="code" href="namespacecmfd__jacobian__operator.html#aade100f099e0a5a94c9247ff7310b676">nx</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(1)
<a name="l00074"></a>00074     <a class="code" href="namespacecmfd__jacobian__operator.html#a4eff5cd260d73a37745eadedcb582b00">ny</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(2)
<a name="l00075"></a>00075     <a class="code" href="namespacecmfd__jacobian__operator.html#a194567d4fd0cd9093ff3096be8d38418">nz</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(3)
<a name="l00076"></a>00076     <a class="code" href="namespacecmfd__jacobian__operator.html#a417852f6bd56b5d466aa9bee0064b057">ng</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(4)
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     <span class="comment">! get number of nonzeros</span>
<a name="l00079"></a>00079     this%nnz = 7 + <a class="code" href="namespacecmfd__jacobian__operator.html#a417852f6bd56b5d466aa9bee0064b057">ng</a> - 1
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <span class="comment">! calculate dimensions of matrix</span>
<a name="l00082"></a>00082     this%n = <a class="code" href="namespacecmfd__jacobian__operator.html#aade100f099e0a5a94c9247ff7310b676">nx</a>*<a class="code" href="namespacecmfd__jacobian__operator.html#a4eff5cd260d73a37745eadedcb582b00">ny</a>*<a class="code" href="namespacecmfd__jacobian__operator.html#a194567d4fd0cd9093ff3096be8d38418">nz</a>*<a class="code" href="namespacecmfd__jacobian__operator.html#a417852f6bd56b5d466aa9bee0064b057">ng</a>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">! add 1 for eigenvalue row</span>
<a name="l00085"></a>00085 <span class="comment">!   this%n = this%n + 1</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">  end subroutine get_J_indices</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">!===============================================================================</span>
<a name="l00090"></a>00090 <span class="comment">! PREALLOCATE_JACOBIAN_MATRIX</span>
<a name="l00091"></a>00091 <span class="comment">!===============================================================================</span>
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="namespacecmfd__jacobian__operator.html#a9abb734d2b1afc97812890b5d95aec70">00093</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__jacobian__operator.html#a9abb734d2b1afc97812890b5d95aec70">preallocate_jacobian_matrix</a>(this,ctx)
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     use <span class="keywordflow">global</span>, only: cmfd,rank,n_procs
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="keywordtype">type(jacobian_operator)</span> :: this
<a name="l00098"></a>00098     <span class="keywordtype">type(operators)</span>         :: ctx
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordtype">integer</span> :: i             <span class="comment">! iteration counter for x</span>
<a name="l00101"></a>00101     <span class="keywordtype">integer</span> :: j             <span class="comment">! iteration counter for y</span>
<a name="l00102"></a>00102     <span class="keywordtype">integer</span> :: k             <span class="comment">! iteration counter for z</span>
<a name="l00103"></a>00103     <span class="keywordtype">integer</span> :: g             <span class="comment">! iteration counter for groups</span>
<a name="l00104"></a>00104     <span class="keywordtype">integer</span> :: l             <span class="comment">! iteration counter for leakages</span>
<a name="l00105"></a>00105     <span class="keywordtype">integer</span> :: h             <span class="comment">! energy group when doing scattering</span>
<a name="l00106"></a>00106     <span class="keywordtype">integer</span> :: n             <span class="comment">! the extent of the matrix</span>
<a name="l00107"></a>00107     <span class="keywordtype">integer</span> :: irow          <span class="comment">! row counter</span>
<a name="l00108"></a>00108     <span class="keywordtype">integer</span> :: bound(6)      <span class="comment">! vector for comparing when looking for bound</span>
<a name="l00109"></a>00109     <span class="keywordtype">integer</span> :: xyz_idx       <span class="comment">! index for determining if x,y or z leakage</span>
<a name="l00110"></a>00110     <span class="keywordtype">integer</span> :: dir_idx       <span class="comment">! index for determining - or + face of cell</span>
<a name="l00111"></a>00111     <span class="keywordtype">integer</span> :: neig_idx(3)   <span class="comment">! spatial indices of neighbour</span>
<a name="l00112"></a>00112     <span class="keywordtype">integer</span> :: nxyz(3,2)     <span class="comment">! single vector containing bound. locations</span>
<a name="l00113"></a>00113     <span class="keywordtype">integer</span> :: shift_idx     <span class="comment">! parameter to shift index by +1 or -1</span>
<a name="l00114"></a>00114     <span class="keywordtype">integer</span> :: row_start     <span class="comment">! index of local starting row</span>
<a name="l00115"></a>00115     <span class="keywordtype">integer</span> :: row_end       <span class="comment">! index of local final row</span>
<a name="l00116"></a>00116     <span class="keywordtype">integer</span> :: neig_mat_idx  <span class="comment">! matrix index of neighbor cell</span>
<a name="l00117"></a>00117     <span class="keywordtype">integer</span> :: scatt_mat_idx <span class="comment">! matrix index for h--&gt;g scattering terms</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">! get local problem size</span>
<a name="l00120"></a>00120     n = this%n
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">! determine local size, divide evenly between all other procs</span>
<a name="l00123"></a>00123     this%localn = n/(<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>)
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">! add 1 more if less proc id is less than mod</span>
<a name="l00126"></a>00126     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> &lt; mod(n,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>)) this%localn = this%localn + 1
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="comment">! add another 1 on last proc</span>
<a name="l00129"></a>00129     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) this%localn = this%localn + 1
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="comment">! determine local starting row</span>
<a name="l00132"></a>00132     row_start = 0
<a name="l00133"></a>00133     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> &lt; mod(n,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>)) <span class="keyword">then</span>
<a name="l00134"></a>00134       row_start = <a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a>*(n/<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>+1)
<a name="l00135"></a>00135     <span class="keyword">else</span>
<a name="l00136"></a>00136       row_start = min(mod(n,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>)*(n/<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>+1)+(<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> - mod(n,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>))*(n/<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>),n)
<a name="l00137"></a>00137     <span class="keyword">end if</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">! determine local final row</span>
<a name="l00140"></a>00140     row_end = row_start + this%localn - 1
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="comment">! allocate counters</span>
<a name="l00143"></a>00143     <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(this%d_nnz)) <span class="keyword">allocate</span>(this%d_nnz(row_start:row_end))
<a name="l00144"></a>00144     <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(this%o_nnz)) <span class="keyword">allocate</span>(this%o_nnz(row_start:row_end))
<a name="l00145"></a>00145     this % d_nnz = 0
<a name="l00146"></a>00146     this % o_nnz = 0
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="comment">! start with pattern from loss matrix</span>
<a name="l00149"></a>00149     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) <span class="keyword">then</span>
<a name="l00150"></a>00150       this % d_nnz(row_start:row_end-1) = ctx%loss%d_nnz
<a name="l00151"></a>00151       this % o_nnz(row_start:row_end-1) = ctx%loss%o_nnz
<a name="l00152"></a>00152     <span class="keyword">else</span>
<a name="l00153"></a>00153       this % d_nnz = ctx%loss%d_nnz
<a name="l00154"></a>00154       this % o_nnz = ctx%loss%o_nnz
<a name="l00155"></a>00155     <span class="keyword">end if</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">! append -F*phi term for last processor will take care of 1 for lambda</span>
<a name="l00158"></a>00158     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) <span class="keyword">then</span>
<a name="l00159"></a>00159       this%d_nnz = this%d_nnz + 1
<a name="l00160"></a>00160     <span class="keyword">else</span>
<a name="l00161"></a>00161       this%o_nnz = this%o_nnz + 1
<a name="l00162"></a>00162     <span class="keyword">end if</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="comment">! do last row which has all filled (already did lower left corner above)</span>
<a name="l00165"></a>00165     <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) <span class="keyword">then</span>
<a name="l00166"></a>00166       this % d_nnz(row_end) = this % d_nnz(row_end) + (row_end - row_start)
<a name="l00167"></a>00167       this % o_nnz(row_end) = this % o_nnz(row_end) + ((this%n-1) - (row_end - &amp;
<a name="l00168"></a>00168      &amp;                                                 row_start))
<a name="l00169"></a>00169     <span class="keyword">end if</span>
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keyword">  end subroutine preallocate_jacobian_matrix</span>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="comment">!===============================================================================</span>
<a name="l00174"></a>00174 <span class="comment">! BUILD_JACOBIAN_MATRIX creates the matrix representing loss of neutrons</span>
<a name="l00175"></a>00175 <span class="comment">!===============================================================================</span>
<a name="l00176"></a>00176 
<a name="l00177"></a><a class="code" href="namespacecmfd__jacobian__operator.html#ac2d1b67173c3e7f9e41479ae5b95e3eb">00177</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__jacobian__operator.html#ac2d1b67173c3e7f9e41479ae5b95e3eb">build_jacobian_matrix</a>(snes,x,jac,jac_prec,flag,ctx,ierr)
<a name="l00178"></a>00178 
<a name="l00179"></a>00179      use <span class="keywordflow">global</span>, only: rank,n_procs
<a name="l00180"></a>00180 
<a name="l00181"></a>00181      <span class="comment">! formal variables</span>
<a name="l00182"></a>00182      SNES            :: snes      <span class="comment">! the snes context</span>
<a name="l00183"></a>00183      Vec             :: x         <span class="comment">! the solution vector</span>
<a name="l00184"></a>00184      Mat             :: jac       <span class="comment">! the jacobian matrix</span>
<a name="l00185"></a>00185      Mat             :: jac_prec  <span class="comment">! the jacobian preconditioner</span>
<a name="l00186"></a>00186      MatStructure    :: flag      <span class="comment">! not used</span>
<a name="l00187"></a>00187      <span class="keywordtype">type(operators)</span> :: ctx       <span class="comment">! not used</span>
<a name="l00188"></a>00188      <span class="keywordtype">integer</span>         :: ierr      <span class="comment">! petsc error flag</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190      <span class="comment">! local varibles</span>
<a name="l00191"></a>00191      Vec                  :: phi      <span class="comment">! flux vector</span>
<a name="l00192"></a>00192      Vec                  :: source   <span class="comment">! source vector</span>
<a name="l00193"></a>00193      <span class="keywordtype">integer</span>              :: n        <span class="comment">! problem size</span>
<a name="l00194"></a>00194      <span class="keywordtype">integer</span>              :: k        <span class="comment">! implied do loop counter</span>
<a name="l00195"></a>00195      <span class="keywordtype">integer</span>              :: ncols    <span class="comment">! number of nonzeros in cols</span>
<a name="l00196"></a>00196      <span class="keywordtype">integer</span>              :: irow     <span class="comment">! row counter</span>
<a name="l00197"></a>00197      <span class="keywordtype">integer</span>              :: row_start<span class="comment">! starting local row on process</span>
<a name="l00198"></a>00198      <span class="keywordtype">integer</span>              :: row_end  <span class="comment">! ending local row on process</span>
<a name="l00199"></a>00199      <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: dims(:)  <span class="comment">! vec of starting and ending rows</span>
<a name="l00200"></a>00200      <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: dims1(:) <span class="comment">! vec of sizes on each proc</span>
<a name="l00201"></a>00201      <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: nnzv(:)  <span class="comment">! vector of number of nonzeros for jac</span>
<a name="l00202"></a>00202      <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: cols(:)  <span class="comment">! vector of column numbers</span>
<a name="l00203"></a>00203      <span class="keywordtype">real(8)</span>              :: lambda   <span class="comment">! eigenvalue</span>
<a name="l00204"></a>00204      <span class="keywordtype">real(8)</span>, <span class="keywordtype">pointer</span>     :: xptr(:)  <span class="comment">! pointer to solution vector</span>
<a name="l00205"></a>00205      <span class="keywordtype">real(8)</span>, <span class="keywordtype">pointer</span>     :: sptr(:)  <span class="comment">! pointer to source vector</span>
<a name="l00206"></a>00206      <span class="keywordtype">real(8)</span>, <span class="keywordtype">allocatable</span> :: vals(:)  <span class="comment">! vector of row values</span>
<a name="l00207"></a>00207      <span class="keywordtype">real(8)</span>, <span class="keywordtype">allocatable</span> :: phi_tmp(:) <span class="comment">! temp buffer for flux</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209      <span class="comment">! create operators</span>
<a name="l00210"></a>00210      call build_loss_matrix(ctx%loss)
<a name="l00211"></a>00211      call build_prod_matrix(ctx%prod)
<a name="l00212"></a>00212 
<a name="l00213"></a>00213      <span class="comment">! get problem size</span>
<a name="l00214"></a>00214      n = ctx%loss%n
<a name="l00215"></a>00215 
<a name="l00216"></a>00216      <span class="comment">! get local size on each processor</span>
<a name="l00217"></a>00217      call MatGetOwnershipRange(jac_prec,row_start,row_end,ierr)
<a name="l00218"></a>00218 
<a name="l00219"></a>00219      <span class="comment">! allocate cols and  initialize to zero</span>
<a name="l00220"></a>00220      <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(cols)) <span class="keyword">allocate</span>(cols(maxval(ctx%loss%d_nnz+ctx%loss%o_nnz)))
<a name="l00221"></a>00221      <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(vals)) <span class="keyword">allocate</span>(vals(maxval(ctx%loss%d_nnz+ctx%loss%o_nnz)))
<a name="l00222"></a>00222      cols = 0
<a name="l00223"></a>00223      vals = 0.0_8
<a name="l00224"></a>00224 
<a name="l00225"></a>00225      <span class="comment">! get pointers to residual vector </span>
<a name="l00226"></a>00226      call VecGetArrayF90(x,xptr,ierr)
<a name="l00227"></a>00227 
<a name="l00228"></a>00228      <span class="comment">! create petsc vector for flux</span>
<a name="l00229"></a>00229      call VecCreateMPI(PETSC_COMM_WORLD,ctx%loss%localn,PETSC_DECIDE,phi,ierr)
<a name="l00230"></a>00230 
<a name="l00231"></a>00231      <span class="comment">! extract flux and eigenvalue</span>
<a name="l00232"></a>00232      call VecPlaceArray(phi,xptr,ierr)
<a name="l00233"></a>00233      <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) lambda = xptr(<span class="keyword">size</span>(xptr))
<a name="l00234"></a>00234      call MPI_BCAST(lambda,1,MPI_REAL8,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>-1,MPI_COMM_WORLD,ierr)
<a name="l00235"></a>00235 
<a name="l00236"></a>00236      <span class="comment">! compute math (M-lambda*F) M is overwritten here</span>
<a name="l00237"></a>00237      call MatAXPY(ctx%loss%M,-1.0_8*lambda,ctx%prod%F,SUBSET_NONZERO_PATTERN,ierr)
<a name="l00238"></a>00238 
<a name="l00239"></a>00239      <span class="comment">! create tmp petsc vector for source</span>
<a name="l00240"></a>00240      call VecCreateMPI(PETSC_COMM_WORLD,ctx%loss%localn,PETSC_DECIDE,source,ierr)
<a name="l00241"></a>00241 
<a name="l00242"></a>00242      <span class="comment">! perform math (-F*phi --&gt; source)</span>
<a name="l00243"></a>00243      call MatMult(ctx%prod%F,phi,source,ierr)
<a name="l00244"></a>00244      call VecScale(source,-1.0_8,ierr)
<a name="l00245"></a>00245 
<a name="l00246"></a>00246      <span class="comment">! get pointer to source</span>
<a name="l00247"></a>00247      call VecGetArrayF90(source,sptr,ierr)
<a name="l00248"></a>00248 
<a name="l00249"></a>00249      <span class="comment">! begin loop to insert things into matrix</span>
<a name="l00250"></a>00250      <span class="keyword">do</span> irow = row_start,row_end - 1
<a name="l00251"></a>00251 
<a name="l00252"></a>00252        <span class="comment">! don&#39;t do last row</span>
<a name="l00253"></a>00253        <span class="keyword">if</span> (irow == n) cycle 
<a name="l00254"></a>00254 
<a name="l00255"></a>00255        <span class="comment">! get row of matrix</span>
<a name="l00256"></a>00256        call MatGetRow(ctx%loss%M,irow,ncols,cols,vals,ierr)
<a name="l00257"></a>00257 
<a name="l00258"></a>00258        <span class="comment">! set that row to Jacobian matrix</span>
<a name="l00259"></a>00259        call MatSetValues(jac_prec,1,irow,ncols,cols(1:ncols),vals,INSERT_VALUES,ierr)
<a name="l00260"></a>00260 
<a name="l00261"></a>00261        <span class="comment">! restore the row</span>
<a name="l00262"></a>00262        call MatRestoreRow(ctx%loss%M,irow,ncols,cols,vals,ierr)
<a name="l00263"></a>00263 
<a name="l00264"></a>00264        <span class="comment">! insert source value</span>
<a name="l00265"></a>00265        call MatSetValue(jac_prec,irow,n,sptr(irow-row_start+1),INSERT_VALUES,ierr)
<a name="l00266"></a>00266 
<a name="l00267"></a>00267      <span class="keyword">end do</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269      <span class="comment">! allocate space for flux vector buffer</span>
<a name="l00270"></a>00270      <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) <span class="keyword">then</span>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272        <span class="comment">! temporary receive buffer</span>
<a name="l00273"></a>00273        <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(phi_tmp)) <span class="keyword">allocate</span>(phi_tmp(0:n-1))
<a name="l00274"></a>00274 
<a name="l00275"></a>00275      <span class="keyword">end if</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277      <span class="comment">! get size on each proc</span>
<a name="l00278"></a>00278      <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(dims)) <span class="keyword">allocate</span>(dims(0:<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>))
<a name="l00279"></a>00279      <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(dims1)) <span class="keyword">allocate</span>(dims1(0:<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>-1))
<a name="l00280"></a>00280      call VecGetOwnershipRanges(phi,dims,ierr)
<a name="l00281"></a>00281      <span class="keyword">do</span> k = 0,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>-1
<a name="l00282"></a>00282        dims1(k) = dims(k+1) - dims(k)
<a name="l00283"></a>00283      <span class="keyword">end do</span>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285      <span class="comment">! gather data on all procs (will truncate xptr if needed for last proc)</span>
<a name="l00286"></a>00286      call MPI_GATHERV(xptr,dims1(<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a>),MPI_REAL8,phi_tmp,dims1,dims(0:<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>-1),MPI_REAL8,<a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a>-1,MPI_COMM_WORLD,ierr)
<a name="l00287"></a>00287 
<a name="l00288"></a>00288      <span class="comment">! set values in last row of matrix</span>
<a name="l00289"></a>00289      <span class="keyword">if</span> (<a class="code" href="namespaceglobal.html#acda9083f93badb517a273517039add35">rank</a> == <a class="code" href="namespaceglobal.html#aae3953228b511d4d2553a0bb319a3683">n_procs</a> - 1) <span class="keyword">then</span>
<a name="l00290"></a>00290        phi_tmp = -1.0_8*phi_tmp <span class="comment">! negate the transpose</span>
<a name="l00291"></a>00291        call MatSetValues(jac_prec,1,n,n,(/(k,k=0,n-1)/),phi_tmp,INSERT_VALUES,ierr)
<a name="l00292"></a>00292        call MatSetValue(jac_prec,n,n,1.0_8,INSERT_VALUES,ierr)
<a name="l00293"></a>00293      <span class="keyword">end if</span>
<a name="l00294"></a>00294 
<a name="l00295"></a>00295      <span class="comment">! assemble matrix</span>
<a name="l00296"></a>00296      call MatAssemblyBegin(jac_prec,MAT_FINAL_ASSEMBLY,ierr)
<a name="l00297"></a>00297      call MatAssemblyEnd(jac_prec,MAT_FINAL_ASSEMBLY,ierr)
<a name="l00298"></a>00298      call MatAssemblyBegin(jac,MAT_FINAL_ASSEMBLY,ierr)
<a name="l00299"></a>00299      call MatAssemblyEnd(jac,MAT_FINAL_ASSEMBLY,ierr)
<a name="l00300"></a>00300 
<a name="l00301"></a>00301      <span class="comment">! reset all vectors</span>
<a name="l00302"></a>00302      call VecResetArray(phi,ierr)
<a name="l00303"></a>00303 
<a name="l00304"></a>00304      <span class="comment">! restore all vectors</span>
<a name="l00305"></a>00305      call VecRestoreArrayF90(x,xptr,ierr)
<a name="l00306"></a>00306      call VecRestoreArrayF90(source,sptr,ierr)
<a name="l00307"></a>00307 
<a name="l00308"></a>00308      <span class="comment">! destroy all temporary objects</span>
<a name="l00309"></a>00309      call VecDestroy(phi,ierr)
<a name="l00310"></a>00310      call VecDestroy(source,ierr)
<a name="l00311"></a>00311 
<a name="l00312"></a>00312      <span class="comment">! deallocate all temporary space</span>
<a name="l00313"></a>00313      <span class="keyword">if</span> (<span class="keyword">allocated</span>(cols)) <span class="keyword">deallocate</span>(cols)
<a name="l00314"></a>00314      <span class="keyword">if</span> (<span class="keyword">allocated</span>(vals)) <span class="keyword">deallocate</span>(vals)
<a name="l00315"></a>00315      <span class="keyword">if</span> (<span class="keyword">allocated</span>(phi_tmp)) <span class="keyword">deallocate</span>(phi_tmp)
<a name="l00316"></a>00316      <span class="keyword">if</span> (<span class="keyword">allocated</span>(dims)) <span class="keyword">deallocate</span>(dims)
<a name="l00317"></a>00317      <span class="keyword">if</span> (<span class="keyword">allocated</span>(dims1)) <span class="keyword">deallocate</span>(dims1)
<a name="l00318"></a>00318 
<a name="l00319"></a>00319      <span class="comment">! print jacobian out</span>
<a name="l00320"></a>00320      call <a class="code" href="namespacecmfd__jacobian__operator.html#ae692ca15014be57cd27479ea8f5de889">print_J_operator</a>(jac_prec)
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="keyword">  end subroutine build_jacobian_matrix </span>
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">!===============================================================================</span>
<a name="l00325"></a>00325 <span class="comment">! PRINT_J_OPERATOR </span>
<a name="l00326"></a>00326 <span class="comment">!===============================================================================</span>
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="namespacecmfd__jacobian__operator.html#ae692ca15014be57cd27479ea8f5de889">00328</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__jacobian__operator.html#ae692ca15014be57cd27479ea8f5de889">print_J_operator</a>(jac)
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     Mat :: jac 
<a name="l00331"></a>00331     PetscViewer :: viewer
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="comment">! write out matrix in binary file (debugging)</span>
<a name="l00334"></a>00334     call PetscViewerBinaryOpen(PETSC_COMM_WORLD,<span class="stringliteral">&#39;jacobian.bin&#39;</span>&amp;
<a name="l00335"></a>00335    &amp;     ,FILE_MODE_WRITE,viewer,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00336"></a>00336     call MatView(jac,viewer,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00337"></a>00337     call PetscViewerDestroy(viewer,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="keyword">  end subroutine print_J_operator</span>
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">!==============================================================================</span>
<a name="l00342"></a>00342 <span class="comment">! DESTROY_J_OPERATOR</span>
<a name="l00343"></a>00343 <span class="comment">!==============================================================================</span>
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="namespacecmfd__jacobian__operator.html#a95ee83b3c9b9cd5e547ffc86001b8016">00345</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__jacobian__operator.html#a95ee83b3c9b9cd5e547ffc86001b8016">destroy_J_operator</a>(this)
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keywordtype">type(jacobian_operator)</span> :: this
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="comment">! deallocate matrix</span>
<a name="l00350"></a>00350     call MatDestroy(this%J,<a class="code" href="namespacecmfd__jacobian__operator.html#aaf43af360638b2d219a3af1a91b472cb">ierr</a>)
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">! deallocate other parameters</span>
<a name="l00353"></a>00353     <span class="keyword">if</span> (<span class="keyword">allocated</span>(this%d_nnz)) <span class="keyword">deallocate</span>(this%d_nnz)
<a name="l00354"></a>00354     <span class="keyword">if</span> (<span class="keyword">allocated</span>(this%o_nnz)) <span class="keyword">deallocate</span>(this%o_nnz)
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="keyword">  end subroutine destroy_J_operator</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keyword">end module cmfd_jacobian_operator</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Feb 20 2012 19:49:35 for CMFD by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
