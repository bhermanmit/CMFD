<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMFD: /home/bherman/Documents/PhD/CMFD/src/cmfd_prod_operator.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CMFD</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>      </li>
      <li class="navelem"><a class="el" href="dir_afcdd5e0edc0b371418ed6fb21b6270d.html">bherman</a>      </li>
      <li class="navelem"><a class="el" href="dir_3201ddb1ceaf11262981f79926d55b34.html">Documents</a>      </li>
      <li class="navelem"><a class="el" href="dir_8618e8944a8ba0368b5596bf6a0bf90b.html">PhD</a>      </li>
      <li class="navelem"><a class="el" href="dir_0e285d84ac0545df775f743b98d4c43a.html">CMFD</a>      </li>
      <li class="navelem"><a class="el" href="dir_6146a08e605ebd85439d35f097622cfc.html">src</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>cmfd_prod_operator.F90</h1>  </div>
</div>
<div class="contents">
<a href="cmfd__prod__operator_8F90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacecmfd__prod__operator.html">00001</a> <span class="keyword">module</span> cmfd_prod_operator
<a name="l00002"></a>00002 
<a name="l00003"></a>00003   <span class="keyword">implicit none</span>
<a name="l00004"></a>00004   <span class="keywordtype">private</span>
<a name="l00005"></a>00005   <span class="keywordtype">public</span> :: <a class="code" href="namespacecmfd__prod__operator.html#a4d3f9798f6553896c732ce7003f16621">init_F_operator</a>,<a class="code" href="namespacecmfd__prod__operator.html#af32a0a950933738728ecdb1688270b08">build_prod_matrix</a>,<a class="code" href="namespacecmfd__prod__operator.html#ab9d5afa6dfb8d1ee93d43d340a69ad8a">destroy_F_operator</a>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;finclude/petsc.h90&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">00009</a>     <span class="keywordtype">integer</span>  :: nx   <span class="comment">! maximum number of x cells</span>
<a name="l00010"></a><a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">00010</a>     <span class="keywordtype">integer</span>  :: ny   <span class="comment">! maximum number of y cells</span>
<a name="l00011"></a><a class="code" href="namespacecmfd__prod__operator.html#a5de5dd4626ff3322e4453db93e97f323">00011</a>     <span class="keywordtype">integer</span>  :: nz   <span class="comment">! maximum number of z cells</span>
<a name="l00012"></a><a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">00012</a>     <span class="keywordtype">integer</span>  :: ng   <span class="comment">! maximum number of groups</span>
<a name="l00013"></a><a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">00013</a>     <span class="keywordtype">integer</span>  :: ierr <span class="comment">! petsc error code</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015   <span class="keyword">type</span>, public :: prod_operator
<a name="l00016"></a>00016 
<a name="l00017"></a>00017     Mat      :: F    <span class="comment">! petsc matrix for neutronic prod operator</span>
<a name="l00018"></a>00018     <span class="keywordtype">integer</span>  :: n    <span class="comment">! dimensions of matrix</span>
<a name="l00019"></a>00019     <span class="keywordtype">integer</span>  :: nnz  <span class="comment">! max number of nonzeros</span>
<a name="l00020"></a>00020     <span class="keywordtype">integer</span>  :: localn <span class="comment">! local size on proc</span>
<a name="l00021"></a>00021     <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: d_nnz(:) <span class="comment">! vector of diagonal preallocation</span>
<a name="l00022"></a>00022     <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: o_nnz(:) <span class="comment">! vector of off-diagonal preallocation</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keyword">  end type prod_operator</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">contains</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">!==============================================================================</span>
<a name="l00029"></a>00029 <span class="comment">! INIT_F_OPERATOR</span>
<a name="l00030"></a>00030 <span class="comment">!==============================================================================</span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="namespacecmfd__prod__operator.html#a4d3f9798f6553896c732ce7003f16621">00032</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#a4d3f9798f6553896c732ce7003f16621">init_F_operator</a>(this)
<a name="l00033"></a>00033 
<a name="l00034"></a>00034     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00035"></a>00035 
<a name="l00036"></a>00036     <span class="comment">! get indices</span>
<a name="l00037"></a>00037     call get_F_indices(this)
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="comment">! get preallocation</span>
<a name="l00040"></a>00040     call <a class="code" href="namespacecmfd__prod__operator.html#ae74dae4cf332d3d8fb0bfedced8e33c5">preallocate_prod_matrix</a>(this)
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     <span class="comment">! set up M operator</span>
<a name="l00043"></a>00043     call MatCreateMPIAIJ(PETSC_COMM_WORLD,this%localn,this%localn,PETSC_DECIDE,&amp;
<a name="l00044"></a>00044    &amp; PETSC_DECIDE,PETSC_NULL_INTEGER,this%d_nnz,PETSC_NULL_INTEGER,this%o_nnz, &amp;
<a name="l00045"></a>00045    &amp; this%F,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00046"></a>00046     call MatSetOption(this%F,MAT_NEW_NONZERO_LOCATIONS,PETSC_TRUE,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00047"></a>00047     call MatSetOption(this%F,MAT_IGNORE_ZERO_ENTRIES,PETSC_TRUE,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">  end subroutine init_F_operator</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">!==============================================================================</span>
<a name="l00052"></a>00052 <span class="comment">! GET_F_INDICES</span>
<a name="l00053"></a>00053 <span class="comment">!==============================================================================</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="keyword">subroutine </span>get_F_indices(this)
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00060"></a>00060 
<a name="l00061"></a>00061     <span class="comment">! get maximum number of cells in each direction</span>
<a name="l00062"></a>00062     <a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(1)
<a name="l00063"></a>00063     <a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(2)
<a name="l00064"></a>00064     <a class="code" href="namespacecmfd__prod__operator.html#a5de5dd4626ff3322e4453db93e97f323">nz</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(3)
<a name="l00065"></a>00065     <a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a> = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%indices(4)
<a name="l00066"></a>00066 
<a name="l00067"></a>00067     <span class="comment">! get number of nonzeros</span>
<a name="l00068"></a>00068     this%nnz = 7 + <a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a> - 1
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="comment">! calculate dimensions of matrix</span>
<a name="l00071"></a>00071     this%n = <a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*<a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a>*<a class="code" href="namespacecmfd__prod__operator.html#a5de5dd4626ff3322e4453db93e97f323">nz</a>*<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="keyword">  end subroutine get_F_indices</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">!===============================================================================</span>
<a name="l00076"></a>00076 <span class="comment">! PREALLOCATE_PROD_MATRIX</span>
<a name="l00077"></a>00077 <span class="comment">!===============================================================================</span>
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="namespacecmfd__prod__operator.html#ae74dae4cf332d3d8fb0bfedced8e33c5">00079</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#ae74dae4cf332d3d8fb0bfedced8e33c5">preallocate_prod_matrix</a>(this)
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordtype">integer</span> :: rank          <span class="comment">! rank of processor</span>
<a name="l00086"></a>00086     <span class="keywordtype">integer</span> :: sizen         <span class="comment">! number of procs</span>
<a name="l00087"></a>00087     <span class="keywordtype">integer</span> :: i             <span class="comment">! iteration counter for x</span>
<a name="l00088"></a>00088     <span class="keywordtype">integer</span> :: j             <span class="comment">! iteration counter for y</span>
<a name="l00089"></a>00089     <span class="keywordtype">integer</span> :: k             <span class="comment">! iteration counter for z</span>
<a name="l00090"></a>00090     <span class="keywordtype">integer</span> :: g             <span class="comment">! iteration counter for groups</span>
<a name="l00091"></a>00091     <span class="keywordtype">integer</span> :: h             <span class="comment">! energy group when doing scattering</span>
<a name="l00092"></a>00092     <span class="keywordtype">integer</span> :: n             <span class="comment">! the extent of the matrix</span>
<a name="l00093"></a>00093     <span class="keywordtype">integer</span> :: irow          <span class="comment">! row counter</span>
<a name="l00094"></a>00094     <span class="keywordtype">integer</span> :: row_start     <span class="comment">! index of local starting row</span>
<a name="l00095"></a>00095     <span class="keywordtype">integer</span> :: row_end       <span class="comment">! index of local final row</span>
<a name="l00096"></a>00096     <span class="keywordtype">integer</span> :: hmat_idx      <span class="comment">! index in matrix for energy group h</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="comment">! get rank and max rank of procs</span>
<a name="l00099"></a>00099     call MPI_COMM_RANK(MPI_COMM_WORLD,rank,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00100"></a>00100     call MPI_COMM_SIZE(MPI_COMM_WORLD,sizen,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">! get local problem size</span>
<a name="l00103"></a>00103     n = this%n
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="comment">! determine local size, divide evenly between all other procs</span>
<a name="l00106"></a>00106     this%localn = n/(sizen)
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <span class="comment">! add 1 more if less proc id is less than mod</span>
<a name="l00109"></a>00109     <span class="keyword">if</span> (rank &lt; mod(n,sizen)) this%localn = this%localn + 1
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">! determine local starting row</span>
<a name="l00112"></a>00112     row_start = 0
<a name="l00113"></a>00113     <span class="keyword">if</span> (rank &lt; mod(n,sizen)) <span class="keyword">then</span>
<a name="l00114"></a>00114       row_start = rank*(n/sizen+1)
<a name="l00115"></a>00115     <span class="keyword">else</span>
<a name="l00116"></a>00116       row_start = min(mod(n,sizen)*(n/sizen+1)+(rank - mod(n,sizen))*(n/sizen),n)
<a name="l00117"></a>00117     <span class="keyword">end if</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">! determine local final row</span>
<a name="l00120"></a>00120     row_end = row_start + this%localn - 1
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">! allocate counters</span>
<a name="l00123"></a>00123     <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(this%d_nnz)) <span class="keyword">allocate</span>(this%d_nnz(row_start:row_end))
<a name="l00124"></a>00124     <span class="keyword">if</span> (.not. <span class="keyword">allocated</span>(this%o_nnz)) <span class="keyword">allocate</span>(this%o_nnz(row_start:row_end))
<a name="l00125"></a>00125     this % d_nnz = 0
<a name="l00126"></a>00126     this % o_nnz = 0
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="comment">! begin loop around local rows</span>
<a name="l00129"></a>00129     ROWS: <span class="keyword">do</span> irow = row_start,row_end
<a name="l00130"></a>00130 
<a name="l00131"></a>00131       <span class="comment">! initialize counters </span>
<a name="l00132"></a>00132       this%d_nnz(irow) = 1 <span class="comment">! already add in matrix diagonal</span>
<a name="l00133"></a>00133       this%o_nnz(irow) = 0
<a name="l00134"></a>00134 
<a name="l00135"></a>00135       <span class="comment">! get location indices</span>
<a name="l00136"></a>00136       call <a class="code" href="namespacecmfd__prod__operator.html#a7693350e6550b480f31618c992ba4c74">matrix_to_indices</a>(irow,g,i,j,k)
<a name="l00137"></a>00137 
<a name="l00138"></a>00138       <span class="comment">! begin loop over off diagonal in-scattering</span>
<a name="l00139"></a>00139       NFISS: <span class="keyword">do</span> h = 1,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="comment">! cycle though if h=g</span>
<a name="l00142"></a>00142         <span class="keyword">if</span> (h == g) <span class="keyword">then</span>
<a name="l00143"></a>00143           cycle
<a name="l00144"></a>00144         <span class="keyword">end if</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         <span class="comment">! get neighbor matrix index</span>
<a name="l00147"></a>00147         call <a class="code" href="namespacecmfd__prod__operator.html#ac2983fe53c57b45472a28c5018e318b4">indices_to_matrix</a>(h,i,j,k,hmat_idx)
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="comment">! record nonzero</span>
<a name="l00150"></a>00150         <span class="keyword">if</span> (((hmat_idx-1) &gt;= row_start) .and.                        &amp;
<a name="l00151"></a>00151        &amp;   ((hmat_idx-1) &lt;= row_end)) <span class="keyword">then</span>
<a name="l00152"></a>00152           this%d_nnz(irow) = this%d_nnz(irow) + 1
<a name="l00153"></a>00153         <span class="keyword">else</span>
<a name="l00154"></a>00154           this%o_nnz(irow) = this%o_nnz(irow) + 1
<a name="l00155"></a>00155         <span class="keyword">end if</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157       <span class="keyword">end do</span> NFISS
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="keyword">end do</span> ROWS
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="keyword">  end subroutine preallocate_prod_matrix</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">!===============================================================================</span>
<a name="l00164"></a>00164 <span class="comment">! BUILD_PROD_MATRIX creates the matrix representing loss of neutrons</span>
<a name="l00165"></a>00165 <span class="comment">!===============================================================================</span>
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="namespacecmfd__prod__operator.html#af32a0a950933738728ecdb1688270b08">00167</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#af32a0a950933738728ecdb1688270b08">build_prod_matrix</a>(this)
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="keywordtype">integer</span> :: i                  <span class="comment">! iteration counter for x</span>
<a name="l00174"></a>00174     <span class="keywordtype">integer</span> :: j                  <span class="comment">! iteration counter for y</span>
<a name="l00175"></a>00175     <span class="keywordtype">integer</span> :: k                  <span class="comment">! iteration counter for z</span>
<a name="l00176"></a>00176     <span class="keywordtype">integer</span> :: g                  <span class="comment">! iteration counter for groups</span>
<a name="l00177"></a>00177     <span class="keywordtype">integer</span> :: l                  <span class="comment">! iteration counter for leakages</span>
<a name="l00178"></a>00178     <span class="keywordtype">integer</span> :: h                  <span class="comment">! energy group when doing scattering</span>
<a name="l00179"></a>00179     <span class="keywordtype">integer</span> :: gmat_idx           <span class="comment">! index in matrix for energy group g</span>
<a name="l00180"></a>00180     <span class="keywordtype">integer</span> :: hmat_idx           <span class="comment">! index in matrix for energy group h</span>
<a name="l00181"></a>00181     <span class="keywordtype">integer</span> :: ierr               <span class="comment">! Petsc error code</span>
<a name="l00182"></a>00182     <span class="keywordtype">integer</span> :: row_start            <span class="comment">! the first local row on the processor</span>
<a name="l00183"></a>00183     <span class="keywordtype">integer</span> :: row_finish           <span class="comment">! the last local row on the processor</span>
<a name="l00184"></a>00184     <span class="keywordtype">integer</span> :: irow                 <span class="comment">! iteration counter over row</span>
<a name="l00185"></a>00185     <span class="keywordtype">real(8)</span> :: nfissxs            <span class="comment">! nufission cross section h--&gt;g</span>
<a name="l00186"></a>00186     <span class="keywordtype">real(8)</span> :: val                <span class="comment">! temporary variable for nfissxs</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="comment">! get row bounds for this processor</span>
<a name="l00189"></a>00189     call MatGetOwnershipRange(this%F,row_start,row_finish,ierr)
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment">! begin iteration loops</span>
<a name="l00192"></a>00192     ROWS: <span class="keyword">do</span> irow = row_start,row_finish-1
<a name="l00193"></a>00193 
<a name="l00194"></a>00194       <span class="comment">! get indices for that row</span>
<a name="l00195"></a>00195       call <a class="code" href="namespacecmfd__prod__operator.html#a7693350e6550b480f31618c992ba4c74">matrix_to_indices</a>(irow,g,i,j,k)
<a name="l00196"></a>00196 
<a name="l00197"></a>00197       <span class="comment">! loop around all other groups </span>
<a name="l00198"></a>00198       NFISS: <span class="keyword">do</span> h = 1,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="comment">! get cell data</span>
<a name="l00201"></a>00201         nfissxs = <a class="code" href="namespaceglobal.html#a445bf66712101e0ed79ecb781abeaea1">cmfd</a>%nfissxs(h,g,i,j,k)
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="comment">! get matrix column location</span>
<a name="l00204"></a>00204         call <a class="code" href="namespacecmfd__prod__operator.html#ac2983fe53c57b45472a28c5018e318b4">indices_to_matrix</a>(h,i,j,k,hmat_idx)
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">! reocrd value in matrix</span>
<a name="l00207"></a>00207         val = nfissxs
<a name="l00208"></a>00208         call MatSetValue(this%F,irow,hmat_idx-1,val,INSERT_VALUES,ierr)
<a name="l00209"></a>00209 
<a name="l00210"></a>00210       <span class="keyword">end do</span> NFISS
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keyword">end do</span> ROWS 
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">! assemble matrix </span>
<a name="l00215"></a>00215     call MatAssemblyBegin(this%F,MAT_FLUSH_ASSEMBLY,ierr)
<a name="l00216"></a>00216     call MatAssemblyEnd(this%F,MAT_FINAL_ASSEMBLY,ierr)
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="comment">! print out operator to file</span>
<a name="l00219"></a>00219     call <a class="code" href="namespacecmfd__prod__operator.html#a9606d81df5a07574e649b84d4625c45d">print_F_operator</a>(this)
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="keyword">  end subroutine build_prod_matrix</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="comment">!===============================================================================</span>
<a name="l00224"></a>00224 <span class="comment">! INDICES_TO_MATRIX takes (x,y,z,g) indices and computes location in matrix </span>
<a name="l00225"></a>00225 <span class="comment">!===============================================================================</span>
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="namespacecmfd__prod__operator.html#ac2983fe53c57b45472a28c5018e318b4">00227</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#ac2983fe53c57b45472a28c5018e318b4">indices_to_matrix</a>(g,i,j,k,matidx)
<a name="l00228"></a>00228   
<a name="l00229"></a>00229     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordtype">integer</span> :: matidx         <span class="comment">! the index location in matrix</span>
<a name="l00232"></a>00232     <span class="keywordtype">integer</span> :: i               <span class="comment">! current x index</span>
<a name="l00233"></a>00233     <span class="keywordtype">integer</span> :: j               <span class="comment">! current y index</span>
<a name="l00234"></a>00234     <span class="keywordtype">integer</span> :: k               <span class="comment">! current z index</span>
<a name="l00235"></a>00235     <span class="keywordtype">integer</span> :: g               <span class="comment">! current group index</span>
<a name="l00236"></a>00236     
<a name="l00237"></a>00237     <span class="comment">! compute index</span>
<a name="l00238"></a>00238     matidx = g + <a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*(i - 1) + <a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*(j - 1) + <a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*<a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a>*(k - 1)
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="keyword">  end subroutine indices_to_matrix</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">!===============================================================================</span>
<a name="l00243"></a>00243 <span class="comment">! MATRIX_TO_INDICES </span>
<a name="l00244"></a>00244 <span class="comment">!===============================================================================</span>
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="namespacecmfd__prod__operator.html#a7693350e6550b480f31618c992ba4c74">00246</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#a7693350e6550b480f31618c992ba4c74">matrix_to_indices</a>(irow,g,i,j,k)
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     use <span class="keywordflow">global</span>, only: cmfd
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keywordtype">integer</span> :: i                    <span class="comment">! iteration counter for x</span>
<a name="l00251"></a>00251     <span class="keywordtype">integer</span> :: j                    <span class="comment">! iteration counter for y</span>
<a name="l00252"></a>00252     <span class="keywordtype">integer</span> :: k                    <span class="comment">! iteration counter for z</span>
<a name="l00253"></a>00253     <span class="keywordtype">integer</span> :: g                    <span class="comment">! iteration counter for groups</span>
<a name="l00254"></a>00254     <span class="keywordtype">integer</span> :: irow                 <span class="comment">! iteration counter over row (0 reference)</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="comment">! compute indices</span>
<a name="l00257"></a>00257     g = mod(irow,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>) + 1 
<a name="l00258"></a>00258     i = mod(irow,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>)/<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a> + 1
<a name="l00259"></a>00259     j = mod(irow,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*<a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a>)/(<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>)+ 1
<a name="l00260"></a>00260     k = mod(irow,<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*<a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a>*<a class="code" href="namespacecmfd__prod__operator.html#a5de5dd4626ff3322e4453db93e97f323">nz</a>)/(<a class="code" href="namespacecmfd__prod__operator.html#aa402b5c78688aa56652f2176dce1df81">ng</a>*<a class="code" href="namespacecmfd__prod__operator.html#aeb543af869f9e05b4c1aeb34025a6adf">nx</a>*<a class="code" href="namespacecmfd__prod__operator.html#a221ea0e99dbbba2fac517c8e2b5b056f">ny</a>) + 1
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="keyword">  end subroutine matrix_to_indices</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">!===============================================================================</span>
<a name="l00265"></a>00265 <span class="comment">! PRINT_F_OPERATOR </span>
<a name="l00266"></a>00266 <span class="comment">!===============================================================================</span>
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="namespacecmfd__prod__operator.html#a9606d81df5a07574e649b84d4625c45d">00268</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#a9606d81df5a07574e649b84d4625c45d">print_F_operator</a>(this)
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     PetscViewer :: viewer
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">! write out matrix in binary file (debugging)</span>
<a name="l00275"></a>00275     call PetscViewerBinaryOpen(PETSC_COMM_WORLD,<span class="stringliteral">&#39;prodmat.bin&#39;</span>&amp;
<a name="l00276"></a>00276    &amp;     ,FILE_MODE_WRITE,viewer,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00277"></a>00277     call MatView(this%F,viewer,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00278"></a>00278     call PetscViewerDestroy(viewer,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keyword">  end subroutine print_F_operator</span>
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">!==============================================================================</span>
<a name="l00283"></a>00283 <span class="comment">! DESTROY_F_OPERATOR</span>
<a name="l00284"></a>00284 <span class="comment">!==============================================================================</span>
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="namespacecmfd__prod__operator.html#ab9d5afa6dfb8d1ee93d43d340a69ad8a">00286</a>   <span class="keyword">subroutine </span><a class="code" href="namespacecmfd__prod__operator.html#ab9d5afa6dfb8d1ee93d43d340a69ad8a">destroy_F_operator</a>(this)
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keywordtype">type(prod_operator)</span> :: this
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">! deallocate matrix</span>
<a name="l00291"></a>00291     call MatDestroy(this%F,<a class="code" href="namespacecmfd__prod__operator.html#ad21ab71867a2e0682cf7a9e876453409">ierr</a>)
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">! deallocate other parameters</span>
<a name="l00294"></a>00294     <span class="keyword">if</span> (<span class="keyword">allocated</span>(this%d_nnz)) <span class="keyword">deallocate</span>(this%d_nnz)
<a name="l00295"></a>00295     <span class="keyword">if</span> (<span class="keyword">allocated</span>(this%o_nnz)) <span class="keyword">deallocate</span>(this%o_nnz)
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="keyword">  end subroutine destroy_F_operator</span>
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="keyword">end module cmfd_prod_operator</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Feb 20 2012 19:49:35 for CMFD by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
